<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPT Rich Text Cleaner</title>
  <style>
    /* ── Tokens ─────────────────────────────────────────────── */
    :root {
      --bg:        #f5f5f7;
      --surface:   #ffffff;
      --border:    #e0e0e5;
      --border-focus: #6e6aff;
      --text:      #1a1a2e;
      --text-muted:#7a7a9a;
      --accent:    #6e6aff;
      --accent-hover:#5753e0;
      --accent-2:  #ff6ab0;
      --danger:    #ff4d6a;
      --success:   #22c98a;
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 7px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.07), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.09), 0 1px 4px rgba(0,0,0,0.05);
      --font: "Inter", system-ui, -apple-system, "Segoe UI", sans-serif;
      --mono: "JetBrains Mono", "Fira Mono", monospace;
    }

    /* ── Reset / base ───────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font);
      font-size: 13px;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ── App shell ──────────────────────────────────────────── */
    .app-header {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: var(--shadow-sm);
    }

    .app-icon {
      width: 32px; height: 32px;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .app-icon svg { width: 18px; height: 18px; fill: #fff; }

    .app-title {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: -0.2px;
      color: var(--text);
    }
    .app-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 1px;
    }

    /* ── Toolbar ────────────────────────────────────────────── */
    .toolbar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 10px 24px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .toolbar-divider {
      width: 1px;
      height: 24px;
      background: var(--border);
      margin: 0 6px;
      flex-shrink: 0;
    }

    /* Primary action buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: var(--radius-md);
      border: none;
      font-family: var(--font);
      font-size: 12.5px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s, box-shadow 0.15s, transform 0.1s;
      white-space: nowrap;
    }
    .btn:active { transform: scale(0.97); }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 8px rgba(110,106,255,0.35);
    }
    .btn-primary:hover { background: var(--accent-hover); box-shadow: 0 3px 12px rgba(110,106,255,0.45); }

    .btn-secondary {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--border);
    }
    .btn-secondary:hover { background: var(--bg); border-color: #bbb; }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid transparent;
    }
    .btn-ghost:hover { background: var(--bg); color: var(--text); border-color: var(--border); }

    .btn svg { width: 14px; height: 14px; flex-shrink: 0; }

    /* Toggle chips */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 11px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface);
      font-size: 12px;
      font-family: var(--font);
      color: var(--text-muted);
      cursor: pointer;
      user-select: none;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .chip input[type="checkbox"] { display: none; }
    .chip .chip-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--border);
      transition: background 0.15s;
      flex-shrink: 0;
    }
    .chip.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(110,106,255,0.06);
    }
    .chip.active .chip-dot { background: var(--accent); }

    /* Colour picker control */
    .color-control {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 5px 11px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface);
      font-size: 12px;
      color: var(--text-muted);
      cursor: pointer;
      white-space: nowrap;
    }
    .color-swatch-wrap {
      position: relative;
      width: 20px; height: 20px;
    }
    .color-swatch {
      width: 20px; height: 20px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: #000;
      display: block;
      cursor: pointer;
    }
    #outputColor {
      position: absolute;
      inset: 0;
      opacity: 0;
      width: 100%; height: 100%;
      cursor: pointer;
      border: none;
      padding: 0;
    }

    /* Style select control */
    .select-control {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 5px 11px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface);
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
    }
    .select-control select {
      font-size: 12px;
      font-family: var(--font);
      border: none;
      background: none;
      color: var(--text);
      cursor: pointer;
      outline: none;
      font-weight: 500;
    }

    /* Status badge */
    #status {
      font-size: 11.5px;
      color: var(--text-muted);
      margin-left: auto;
      white-space: nowrap;
    }
    #status.ok   { color: var(--success); }
    #status.fail { color: var(--danger); }

    /* ── Main content ───────────────────────────────────────── */
    .workspace {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 16px 24px 20px;
      min-height: 0;
    }

    .panel {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .panel-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--text-muted);
    }

    .panel-badge {
      font-size: 10.5px;
      font-weight: 500;
      color: var(--text-muted);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 1px 8px;
    }

    .box {
      flex: 1;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 16px;
      overflow: auto;
      background: var(--surface);
      box-shadow: var(--shadow-sm);
      min-height: 60vh;
      transition: border-color 0.2s, box-shadow 0.2s;
      font-size: 14px;
      line-height: 1.6;
    }
    .box[contenteditable="true"] { outline: none; }
    .box:focus-within {
      border-color: var(--border-focus);
      box-shadow: 0 0 0 3px rgba(110,106,255,0.12), var(--shadow-sm);
    }

    /* Input box: dark so white ChatGPT content is visible.
       Force all pasted child elements to render white — without this,
       pasted inline colour styles override the box text colour.       */
    #input {
      background: #2b2b2b;
      border-color: #444;
    }
    #input * { color: #ffffff !important; }
    #input:focus-within {
      border-color: #6e6aff;
      box-shadow: 0 0 0 3px rgba(110,106,255,0.18), var(--shadow-sm);
    }
    #input.box:empty::before { color: #777; }

    /* Output box: white bg, user-chosen colour cascades to all children,
       overriding any #fff inline colours that arrived from ChatGPT.   */
    #output {
      background: #ffffff;
      color: var(--output-color, #000000);
    }
    #output * { color: inherit !important; }

    /* Placeholder text */
    .box:empty::before {
      content: attr(data-placeholder);
      color: var(--text-muted);
      pointer-events: none;
    }

    .panel-hint {
      font-size: 11.5px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    /* ── Pasted content styles — default line-height 1.15 ──────── */
    .box h1, .box h2, .box h3, .box h4 { margin: 0.7em 0 0.35em; line-height: 1.15; }
    .box p  { margin: 0.45em 0; line-height: 1.15; }
    .box ul, .box ol { margin: 0.5em 0 0.5em 1.4em; }
    .box li { margin: 0.2em 0; line-height: 1.15; }
    .box hr { border: 0; border-top: 1px solid var(--border); margin: 0.8em 0; }
    .box table { border-collapse: collapse; width: 100%; }
    .box td, .box th { border: 1px solid var(--border); padding: 6px 10px; font-size: 13px; }
    .box th { background: var(--bg); font-weight: 600; }

    /* ── Compact preset overrides ───────────────────────────── */
    /* px = pt × 1.333 so sizes survive paste into Word/Docs    */
    #output.style-compact p                            { font-size:13.33px; margin-top:0;       margin-bottom:4px;    line-height:1.1; }
    #output.style-compact h1                           { font-size:21.33px; margin-top:8px;      margin-bottom:2.67px; line-height:1.1; }
    #output.style-compact h2                           { font-size:18.67px; margin-top:18.67px;  margin-bottom:2.67px; line-height:1.1; }
    #output.style-compact h3                           { font-size:16px;    margin-top:8px;      margin-bottom:2.67px; line-height:1.1; }
    #output.style-compact h4                           { font-size:13.33px; margin-top:8px;      margin-bottom:2.67px; line-height:1.1; }
    #output.style-compact li                           { margin-top:8px;    margin-bottom:0;     line-height:1.1; }
    #output.style-compact td, #output.style-compact th { font-size:13.33px; padding:0;          line-height:1.1; }
    #output.style-compact table                        { border-collapse:collapse; }

    /* ── Responsive ─────────────────────────────────────────── */
    @media (max-width: 860px) {
      .workspace { grid-template-columns: 1fr; padding: 12px 14px 16px; }
      .box       { min-height: 38vh; }
      .toolbar   { padding: 10px 14px; }
      .app-header{ padding: 12px 14px; }
    }
  </style>
</head>
<body>

  <!-- ── Header ── -->
  <header class="app-header">
    <div class="app-icon">
      <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 5h16v2H4zm0 6h10v2H4zm0 6h13v2H4z"/>
      </svg>
    </div>
    <div>
      <div class="app-title">GPT Rich Text Cleaner</div>
      <div class="app-subtitle">Paste · Clean · Copy into Docs</div>
    </div>
  </header>

  <!-- ── Toolbar ── -->
  <div class="toolbar">

    <!-- Actions -->
    <div class="toolbar-group">
      <button class="btn btn-primary" id="btnClean">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9.5 3l5 9H4.5l5-9zm0 18a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9zm7-1.5L19 18l2.5 1.5L20 22l-1.5-2.5L16 21l1.5-2.5z"/></svg>
        Clean
      </button>
      <button class="btn btn-secondary" id="btnCopy">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4a2 2 0 0 0-2 2v14h2V3h12V1zm3 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2zm0 16H8V7h11v14z"/></svg>
        Copy output
      </button>
      <button class="btn btn-ghost" id="btnClear">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        Clear
      </button>
    </div>

    <div class="toolbar-divider"></div>

    <!-- Toggle options -->
    <div class="toolbar-group" style="flex-wrap:wrap; gap:4px;">
      <label class="chip" id="chipTight">
        <span class="chip-dot"></span>
        <input id="optTight" type="checkbox" />
        Tight mode
      </label>
      <label class="chip active" id="chipBulletGaps">
        <span class="chip-dot"></span>
        <input id="optBulletGaps" type="checkbox" checked />
        No bullet gaps
      </label>
      <label class="chip active" id="chipDividers">
        <span class="chip-dot"></span>
        <input id="optRemoveDividers" type="checkbox" checked />
        Remove dividers
      </label>
      <label class="chip" id="chipHeadings">
        <span class="chip-dot"></span>
        <input id="optNormaliseHeadings" type="checkbox" />
        Normalise headings
      </label>
    </div>

    <div class="toolbar-divider"></div>

    <!-- Output colour -->
    <label class="color-control" title="Set output text colour">
      <span>Colour</span>
      <span class="color-swatch-wrap">
        <span class="color-swatch" id="colorSwatch"></span>
        <input id="outputColor" type="color" value="#000000" />
      </span>
    </label>

    <!-- Style preset -->
    <div class="select-control">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="currentColor" style="opacity:.5"><path d="M3 5h18v2H3zm0 7h12v2H3zm0 7h18v2H3z"/></svg>
      <select id="stylePreset">
        <option value="default">Default</option>
        <option value="compact">Compact</option>
      </select>
    </div>

    <!-- Status -->
    <span id="status"></span>
  </div>

  <!-- ── Workspace ── -->
  <div class="workspace">

    <div class="panel">
      <div class="panel-header">
        <span class="panel-label">Input</span>
        <span class="panel-badge" id="inputBadge">paste here</span>
      </div>
      <div id="input" class="box" contenteditable="true" spellcheck="false"
           data-placeholder="Paste ChatGPT output here…"
           aria-label="Input editor"></div>
      <div class="panel-hint">Paste from ChatGPT, then click <strong>Clean</strong>. Output updates automatically as you type.</div>
    </div>

    <div class="panel">
      <div class="panel-header">
        <span class="panel-label">Cleaned output</span>
        <span class="panel-badge" id="outputBadge">ready to copy</span>
      </div>
      <div id="output" class="box" contenteditable="true" spellcheck="false"
           data-placeholder="Cleaned output will appear here…"
           aria-label="Output editor"></div>
      <div class="panel-hint"><strong>Copy output</strong> puts rich HTML + plain text on your clipboard — paste straight into Google Docs or Word.</div>
    </div>

  </div>

<script>
(function () {
  /* ── Elements ── */
  const input   = document.getElementById("input");
  const output  = document.getElementById("output");
  const status  = document.getElementById("status");
  const inputBadge  = document.getElementById("inputBadge");
  const outputBadge = document.getElementById("outputBadge");

  const optTight             = document.getElementById("optTight");
  const optBulletGaps        = document.getElementById("optBulletGaps");
  const optRemoveDividers    = document.getElementById("optRemoveDividers");
  const optNormaliseHeadings = document.getElementById("optNormaliseHeadings");
  const outputColor          = document.getElementById("outputColor");
  const colorSwatch          = document.getElementById("colorSwatch");
  const stylePreset          = document.getElementById("stylePreset");

  /* ── Chip toggle behaviour ── */
  document.querySelectorAll(".chip").forEach(chip => {
    const cb = chip.querySelector("input[type=checkbox]");
    if (!cb) return;
    chip.addEventListener("click", () => {
      // let the hidden checkbox toggle first, then sync class
      requestAnimationFrame(() => {
        chip.classList.toggle("active", cb.checked);
      });
    });
  });

  /* ── Style presets ── */
  // px = pt × 1.333 so sizes survive paste into Word / Google Docs
  const PRESETS = {
    // Default: just set line-height; everything else uses stylesheet rules
    default: {
      p:  "line-height:1.15;",
      h1: "line-height:1.15;",
      h2: "line-height:1.15;",
      h3: "line-height:1.15;",
      h4: "line-height:1.15;",
      li: "line-height:1.15;",
    },
    // Compact: px = pt × 1.333 so sizes survive paste into Word / Google Docs
    compact: {
      p:     "font-size:13.33px;margin-top:0;margin-bottom:4px;line-height:1.1;",
      h1:    "font-size:21.33px;margin-top:8px;margin-bottom:2.67px;line-height:1.1;",
      h2:    "font-size:18.67px;margin-top:18.67px;margin-bottom:2.67px;line-height:1.1;",
      h3:    "font-size:16px;margin-top:8px;margin-bottom:2.67px;line-height:1.1;",
      h4:    "font-size:13.33px;margin-top:8px;margin-bottom:2.67px;line-height:1.1;",
      li:    "margin-top:8px;margin-bottom:0;line-height:1.1;",
      td:    "font-size:13.33px;padding:0;line-height:1.1;",
      th:    "font-size:13.33px;padding:0;line-height:1.1;",
      table: "border-collapse:collapse;",
    },
  };

  function applyStylePreset() {
    output.classList.remove(...Object.keys(PRESETS).map(k => "style-" + k));
    if (stylePreset.value !== "default") output.classList.add("style-" + stylePreset.value);
  }
  stylePreset.addEventListener("change", applyStylePreset);
  applyStylePreset();

  /* ── Colour picker ── */
  function applyOutputColor() {
    const v = outputColor.value;
    document.documentElement.style.setProperty("--output-color", v);
    colorSwatch.style.background = v;
  }
  outputColor.addEventListener("input", applyOutputColor);
  applyOutputColor();

  /* ── Button wiring ── */
  document.getElementById("btnClean").addEventListener("click", runClean);
  document.getElementById("btnClear").addEventListener("click", () => {
    input.innerHTML = "";
    output.innerHTML = "";
    setStatus("", "");
    inputBadge.textContent  = "paste here";
    outputBadge.textContent = "ready to copy";
    input.focus();
  });
  document.getElementById("btnCopy").addEventListener("click", copyCleanedRich);

  /* ── Cleaning ── */
  function runClean() {
    const opts = {
      tight:             optTight.checked,
      removeBulletGaps:  optBulletGaps.checked,
      removeDividers:    optRemoveDividers.checked,
      normaliseHeadings: optNormaliseHeadings.checked,
    };

    const beforeLen = (input.innerText || "").length;

    const container = document.createElement("div");
    container.innerHTML = input.innerHTML;

    if (opts.removeDividers)    removeDividers(container);
    removeEmptyAndCollapse(container, opts);
    if (opts.removeBulletGaps)  removeBulletGaps(container);
    if (opts.normaliseHeadings) normaliseFakeHeadings(container);
    trimTextNodes(container);

    // Strip inline font-size/line-height/margin so CSS preset rules can override them
    stripInlineFontSizes(container);

    output.innerHTML = container.innerHTML;

    const afterLen = (output.innerText || "").length;
    const saved = beforeLen - afterLen;
    inputBadge.textContent  = `${beforeLen.toLocaleString()} chars`;
    outputBadge.textContent = `${afterLen.toLocaleString()} chars`;
    setStatus(saved > 0 ? `Cleaned · removed ${saved.toLocaleString()} chars` : "Cleaned", "ok");
  }

  function setStatus(msg, cls) {
    status.textContent = msg;
    status.className   = cls || "";
  }

  function removeDividers(root) {
    root.querySelectorAll("hr").forEach(n => n.remove());
    root.querySelectorAll("p, div, span, li, blockquote").forEach(el => {
      const txt = (el.textContent || "").replace(/\u00A0/g, " ").trim();
      if (Array.from(el.childNodes).some(n => n.nodeType === 1)) return;
      if (/^([-*_]\s*){3,}$/.test(txt)) el.remove();
    });
  }

  function isEffectivelyEmpty(el) {
    const meaningfulTags = new Set(["IMG","TABLE","THEAD","TBODY","TR","TD","TH","PRE","CODE","AUDIO","VIDEO"]);
    if (el.querySelector && Array.from(el.querySelectorAll("*")).some(n => meaningfulTags.has(n.tagName))) return false;
    if ((el.textContent || "").replace(/\u00A0/g, " ").trim().length > 0) return false;
    return Array.from(el.childNodes).filter(n => {
      if (n.nodeType === 3) return (n.textContent || "").replace(/\u00A0/g, " ").trim().length > 0;
      if (n.nodeType === 1) return n.tagName !== "BR";
      return false;
    }).length === 0;
  }

  function removeEmptyAndCollapse(root, opts) {
    const walker   = document.createTreeWalker(root, NodeFilter.SHOW_ELEMENT, null);
    const toRemove = [];
    const blockTags = new Set(["P","DIV","SECTION","ARTICLE","BLOCKQUOTE"]);
    while (walker.nextNode()) {
      const el = walker.currentNode;
      if (el.tagName === "BR") continue;
      if (blockTags.has(el.tagName) && isEffectivelyEmpty(el)) toRemove.push(el);
    }
    toRemove.forEach(n => n.remove());
    collapseConsecutiveEmptyBlocks(root, opts.tight);
    if (opts.tight) {
      root.querySelectorAll("p, div, blockquote").forEach(el => { if (isEffectivelyEmpty(el)) el.remove(); });
      root.querySelectorAll("*").forEach(el => {
        if (!el.childNodes || el.childNodes.length < 3) return;
        let brRun = 0;
        Array.from(el.childNodes).forEach(n => {
          if (n.nodeType === 1 && n.tagName === "BR") { brRun++; if (brRun > 1) n.remove(); }
          else if (n.nodeType === 3 && !(n.textContent || "").trim()) { /* skip */ }
          else brRun = 0;
        });
      });
    }
  }

  function collapseConsecutiveEmptyBlocks(root, tight) {
    [root, ...root.querySelectorAll("div, section, article, blockquote")].forEach(parent => {
      let emptyRun = 0;
      Array.from(parent.childNodes).filter(n => n.nodeType === 1).forEach(child => {
        if (!["P","DIV","BLOCKQUOTE"].includes(child.tagName)) { emptyRun = 0; return; }
        if (isEffectivelyEmpty(child)) {
          emptyRun++;
          if (emptyRun > (tight ? 0 : 1)) child.remove();
        } else emptyRun = 0;
      });
    });
  }

  function removeBulletGaps(root) {
    root.querySelectorAll("ul, ol").forEach(list => {
      Array.from(list.children).filter(n => n.tagName === "LI").forEach(li => {
        Array.from(li.querySelectorAll("p, div")).forEach(b => { if (isEffectivelyEmpty(b)) b.remove(); });
      });
      Array.from(list.children).forEach(child => {
        if (child.tagName === "LI" && isEffectivelyEmpty(child)) child.remove();
      });
    });
  }

  function normaliseFakeHeadings(root) {
    root.querySelectorAll("p, div").forEach(el => {
      if (["H1","H2","H3","H4","H5","H6"].includes(el.tagName)) return;
      const children = Array.from(el.childNodes).filter(n => !(n.nodeType === 3 && !(n.textContent || "").trim()));
      if (children.length !== 1) return;
      const only = children[0];
      if (!(only.nodeType === 1 && (only.tagName === "B" || only.tagName === "STRONG"))) return;
      const text = (el.textContent || "").replace(/\u00A0/g, " ").trim();
      if (text.length < 3 || text.length > 120) return;
      const h = document.createElement("h2");
      h.innerHTML = el.innerHTML;
      el.replaceWith(h);
    });
  }

  function stripInlineFontSizes(root) {
    // Pasted ChatGPT HTML often has inline font-size/line-height/margin on block
    // elements. Those beat CSS class rules, so compact preset sizes never apply.
    const tags = ["p","h1","h2","h3","h4","h5","h6","li","td","th"];
    root.querySelectorAll(tags.join(",")).forEach(el => {
      if (!el.style.cssText) return;
      el.style.removeProperty("font-size");
      el.style.removeProperty("line-height");
      el.style.removeProperty("margin");
      el.style.removeProperty("margin-top");
      el.style.removeProperty("margin-bottom");
      if (!el.style.cssText.trim()) el.removeAttribute("style");
    });
  }

  function trimTextNodes(root) {
    const tw = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);
    const toDrop = [];
    while (tw.nextNode()) {
      const n = tw.currentNode;
      const v = (n.nodeValue || "").replace(/\u00A0/g, " ");
      if (!v.trim()) toDrop.push(n);
      else n.nodeValue = v.replace(/[ \t]+\n/g, "\n");
    }
    toDrop.forEach(n => n.remove());
  }

  /* ── Clipboard ── */
  function buildClipboardHtml() {
    const color = outputColor.value || "#000000";
    const rules = PRESETS[stylePreset.value] || null;
    const clone = output.cloneNode(true);

    // Strip inline color from every element via the raw style attribute.
    // el.style.color is unreliable when CSS !important is active — the browser
    // reports the computed value, not the attribute value. Working on the raw
    // getAttribute string bypasses that and removes white colours reliably.
    clone.querySelectorAll("*").forEach(el => {
      const attr = el.getAttribute("style");
      if (!attr) return;
      const stripped = attr
        .replace(/\bcolor\s*:[^;]+;?/gi, "")
        .trim()
        .replace(/;$/, "");
      if (stripped) el.setAttribute("style", stripped);
      else el.removeAttribute("style");
    });

    if (rules) {
      Object.entries(rules).forEach(([tag, css]) => {
        clone.querySelectorAll(tag).forEach(el => {
          el.style.cssText = (el.style.cssText ? el.style.cssText + ";" : "") + css;
        });
      });
    }
    return `<div style="color:${color}">${clone.innerHTML}</div>`;
  }

  async function copyCleanedRich() {
    const html  = buildClipboardHtml();
    const plain = output.innerText || "";
    try {
      await navigator.clipboard.write([
        new ClipboardItem({
          "text/html":  new Blob([html],  { type: "text/html"  }),
          "text/plain": new Blob([plain], { type: "text/plain" }),
        })
      ]);
      setStatus("Copied to clipboard", "ok");
    } catch {
      try {
        const range = document.createRange();
        range.selectNodeContents(output);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
        document.execCommand("copy");
        sel.removeAllRanges();
        setStatus("Copied (fallback — formatting may vary)", "ok");
      } catch {
        setStatus("Copy failed — select output and copy manually", "fail");
      }
    }
  }

  /* ── Auto-clean on input ── */
  let timer = null;
  input.addEventListener("input", () => {
    clearTimeout(timer);
    timer = setTimeout(runClean, 200);
  });

  input.focus();
})();
</script>
</body>
</html>
